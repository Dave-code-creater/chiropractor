version: '3.9'

services:
  # Gateway
  gateway:
    build: ./gateway
    ports:
      - '3000:3000'
    depends_on:
      - auth-service
      - user-service
      - blog-service
    environment:
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h



  # AUTH SERVICE STACK
  auth-db:
    image: postgres:16-alpine
    container_name: auth_db
    restart: always
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
    ports:
      - "5433:5432"
    volumes:
      - auth_pgdata:/var/lib/postgresql/data

  migrate-auth:
    image: postgres:16-alpine
    depends_on:
      - auth-db
    volumes:
      - ./auth-service/migrations:/migrations
    entrypoint: >
      sh -c "
        echo '⏳ Waiting for auth-db...' &&
        sleep 3 &&
        psql postgresql://auth_user:auth_pass@auth-db:5432/auth_db -f /migrations/001_init.sql
        psql postgresql://auth_user:auth_pass@auth-db:5432/auth_db -f /migrations/002_create_doctor.sql
      "

  auth-service:
    build: ./auth-service
    depends_on:
      - auth-db
      - migrate-auth
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      PRO_POSTGRESQL_USER: auth_user
      PRO_POSTGRESQL_PASS: auth_pass
      PRO_POSTGRESQL_HOST: auth-db
      PRO_POSTGRESQL_PORT: 5432
      PRO_POSTGRESQL_NAME: auth_db
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h

  # USER SERVICE STACK
  user-db:
    image: postgres:16-alpine
    container_name: user_db
    restart: always
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user_user
      POSTGRES_PASSWORD: user_pass
    ports:
      - "5434:5432"
    volumes:
      - user_pgdata:/var/lib/postgresql/data

  migrate-user:
    image: postgres:16-alpine
    working_dir: /app
    depends_on:
      - user-db
    volumes:
      - ./user-service/migrations:/migrations
    entrypoint: >
      sh -c "
        echo '⏳ Waiting for user-db...' &&
        sleep 3 &&
        psql postgresql://user_user:user_pass@user-db:5432/user_db -f /migrations/001_init.sql
      "

  user-service:
    build: ./user-service
    depends_on:
      - user-db
      - migrate-user
    ports:
      - '3002:3002'
    environment:
      NODE_ENV: development
      PORT: 3002
      PRO_POSTGRESQL_USER: user_user
      PRO_POSTGRESQL_PASS: user_pass
      PRO_POSTGRESQL_HOST: user-db
      PRO_POSTGRESQL_PORT: 5432
      PRO_POSTGRESQL_NAME: user_db
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h

  blog-service:
    build: ./blog-service
    ports:
      - '3003:3003'
    environment:
      NODE_ENV: development
      PORT: 3003
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h
      PRO_MONGODB_HOST: blog-db
      PRO_MONGODB_PORT: 27017
      PRO_MONGODB_NAME: blog-db
  
  blog-db:
    image: mongo:latest
    container_name: blog-db
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - blog_mongo_data:/data/db
  
  chat-service:
    build: ./chat-service
    ports:
      - '3004:3004'
    environment:
      NODE_ENV: development
      PORT: 3004
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h
      PRO_MONGODB_HOST: blog-db
      PRO_MONGODB_PORT: 27018
      PRO_MONGODB_NAME: blog-db
    
  chat-db:
    image: mongo:latest
    container_name: chat-db
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - chat_mongo_data:/data/db

  # APPOINTMENT SERVICE STACK
  appointment-db:
    image: postgres:16-alpine
    container_name: appointment_db
    restart: always
    environment:
      POSTGRES_DB: appointment_db
      POSTGRES_USER: appointment_user
      POSTGRES_PASSWORD: appointment_pass
    ports:
      - "5435:5432"
    volumes:
      - appointment_pgdata:/var/lib/postgresql/data

  migrate-appointment:
    image: postgres:16-alpine
    depends_on:
      - appointment-db
    volumes:
      - ./appointment-service/migrations:/migrations
    entrypoint: >
      sh -c "
        echo '⏳ Waiting for appointment-db...' &&
        sleep 3 &&
        psql postgresql://appointment_user:appointment_pass@appointment-db:5432/appointment_db -f /migrations/001_init.sql
      "

  appointment-service:
    build: ./appointment-service
    depends_on:
      - appointment-db
      - migrate-appointment
    ports:
      - '3005:3005'
    environment:
      NODE_ENV: development
      PORT: 3005
      PRO_POSTGRESQL_USER: appointment_user
      PRO_POSTGRESQL_PASS: appointment_pass
      PRO_POSTGRESQL_HOST: appointment-db
      PRO_POSTGRESQL_PORT: 5432
      PRO_POSTGRESQL_NAME: appointment_db
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 1h

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  

volumes:
  auth_pgdata:
    driver: local
  user_pgdata:
    driver: local
  blog_mongo_data:
    driver: local
  chat_mongo_data:
    driver: local
  appointment_pgdata:
    driver: local
  rabbitmq_data:
    driver: local
  
networks:
  default:
    driver: bridge
